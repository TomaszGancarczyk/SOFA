@using Guide.Models
@using System.Net
@using Guide.Models.ViewModels;
@model WeaponViewModel

@{
    ViewData["Title"] = "Database";
}

<div class="text-center scrollable padding-top">
    @{
        <img src="@Model.CurrentWeapon.ImgSource" />
        <h1>Id: @Model.CurrentWeapon.Id</h1>
        <h3>@Model.CurrentWeapon.Name</h3>
        <h5>Rarity: @Model.CurrentWeapon.Rarity</h5>
        <h5>Class: @Model.CurrentWeapon.Class</h5>
        <h5>Weight: @Model.CurrentWeapon.Weight</h5>
        if (Model.CurrentWeapon.Features != null && Model.CurrentWeapon.Features.Count > 0)
        {
            <h5>Features:</h5>
            foreach (string feature in Model.CurrentWeapon.Features)
            {
                <p>@feature</p>
            }
        }
        <h5>Stats:</h5>
        foreach (KeyValuePair<string, string> stat in Model.CurrentWeapon.Stats)
        {
            string drawStat = $"{stat.Key}: {stat.Value}";
            <p>
                @drawStat
            </p>
        }
        <p>@Model.CurrentWeapon.Description</p>
        if (Model.CurrentWeapon.DamageGraph != null)
        {
            <canvas id="weaponChart" style="max-width:500px;max-height:300px;"></canvas>
        }
    }
</div>

<script>
    @{
        string xValues = "";
        string yValues = "";
        double graphHeight = 0;
        List<string> distanceLabels = [];
        if (Model.CurrentWeapon.DamageGraph != null)
        {
            graphHeight = Model.CurrentWeapon.DamageGraph.StartDamage + 5;
            double damageDecreaseStart = Model.CurrentWeapon.DamageGraph.DamageDecreaseStart;
            double damageDecreaseEnd = Model.CurrentWeapon.DamageGraph.DamageDecreaseEnd;
            double maxDistance = Model.CurrentWeapon.DamageGraph.MaxDistance;
            double startDamage = @Model.CurrentWeapon.DamageGraph.StartDamage;
            double endDamage = @Model.CurrentWeapon.DamageGraph.EndDamage;
            distanceLabels = [
                "0",
                damageDecreaseStart.ToString().Replace(",", "."),
                damageDecreaseEnd.ToString().Replace(",", "."),
                maxDistance.ToString().Replace(",", ".")
            ];
            // damageDecreaseStart = Model.CurrentWeapon.DamageGraph.DamageDecreaseStart.ToString().Replace(",", ".");
            xValues = $"[0, ";
            yValues = $"[{startDamage.ToString().Replace(",", ".")}, ";
            for (int i = 1; i <= Math.Truncate(maxDistance / 10); i++)
            {
                if (damageDecreaseStart / 10 - i < 1 && damageDecreaseStart / 10 - i >= 0)
                {
                    if (damageDecreaseStart / 10  - i != 0)
                    {
                        xValues += $"{10 * i}, ";
                        yValues += "NaN, ";
                    }
                    xValues += $"{damageDecreaseStart.ToString().Replace(",", ".")}, ";
                    yValues += $"{startDamage.ToString().Replace(",", ".")}, ";
                }
                else if (damageDecreaseEnd / 10 - i < 1 && damageDecreaseEnd / 10 - i >= 0)
                {
                    if (damageDecreaseEnd / 10  - i != 0)
                    {
                        xValues += $"{10 * i}, ";
                        yValues += "NaN, ";
                    }
                    xValues += $"{damageDecreaseEnd.ToString().Replace(",", ".")}, ";
                    yValues += $"{endDamage.ToString().Replace(",", ".")}, ";
                }
                else if (maxDistance / 10 - i < 1 && maxDistance / 10 - i >= 0)
                {
                    if (maxDistance / 10 - i != 0)
                    {
                        xValues += $"{10 * i}, ";
                        yValues += "NaN, ";
                    }
                    xValues += $"{maxDistance.ToString().Replace(",", ".")}]";
                    yValues += $"{endDamage.ToString().Replace(",", ".")}]";
                }
                else
                {
                    xValues += $"{10 * i}, ";
                    yValues += "NaN, ";
                }
            }
        }
    }

    const xValues = @xValues;
    const yValues = @yValues;
    new Chart("weaponChart", {
        type: "line",
        data: {
            labels: xValues,
            datasets:
                [{
                    fill: false,
                    lineTension: 0,
                    backgroundColor: "rgba(255,255,255,0.5)",
                    borderColor: "rgba(255,255,255,0.2)",
                    data: yValues,
                    spanGaps: true,
                }]
        },
        options:
        {
            plugins: {
                legend: { display: false },
            },
            scales:
            {
                x: {
                    border: {
                        color: "rgba(255,255,255,0.2)",
                        width: 2,
                    },
                    grid: {
                        color: "rgba(255,255,255,0.1)",
                    },
                    title: {
                        color: "rgba(255,255,255,0.5)",
                        display: true,
                        text: "Distance",
                    },
                    ticks: {
                        display: true,
                        color: "rgba(255,255,255,0.5)",
                            callback: function(value, index, ticks) {
    @foreach (string label in distanceLabels)
    {
        @:if (this.getLabelForValue(value) == @label)
        @:{
        @:return this.getLabelForValue(value) + "m";
        @:}
    }
                            }
                    }
                },
                y: {
                    border: {
                        color: "rgba(255,255,255,0.2)",
                        width: 2,
                    },
                    grid: {
                        display: false,
                    },
                    title: {
                        color: "rgba(255,255,255,0.5)",
                        display: true,
                        text: "Damage",
                    },
                    min: 0, max: @graphHeight.ToString().Replace(",", "."),
                    ticks: {
                        display: true,
                        color: "rgba(255,255,255,0.5)",
                        stepSize: 10,
                    }
                },
            }
        }
    });
</script>
